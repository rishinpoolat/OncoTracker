@model OncoTrack.Models.Patient
@{
    ViewData["Title"] = "Patient Details";
}

<div class="container mt-4">
    <h2>Patient Details</h2>
    
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5>@Model.User.FirstName @Model.User.LastName</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <strong>Cancer Type:</strong> @Model.CancerType
                </div>
                <div class="col-md-4">
                    <strong>Stage:</strong> @Model.Stage
                </div>
                <div class="col-md-4">
                    <strong>Diagnosis Date:</strong> @Model.DiagnosisDate.ToString("MMM dd, yyyy")
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-4">
                    <strong>Email:</strong> @Model.User.Email
                </div>
                <div class="col-md-4">
                    <strong>Date of Birth:</strong> @Model.User.DateOfBirth.ToString("MMM dd, yyyy")
                </div>
                <div class="col-md-4">
                    <strong>Age:</strong> @((DateTime.Now.Year - Model.User.DateOfBirth.Year)) years
                </div>
            </div>
        </div>
    </div>
    
    <div class="mb-3">
        <a asp-action="AddTreatmentUpdate" asp-route-patientId="@Model.PatientId" class="btn btn-primary">
            <i class="fas fa-notes-medical"></i> Add Treatment Update
        </a>
        <a asp-action="AddMedication" asp-route-patientId="@Model.PatientId" class="btn btn-success">
            <i class="fas fa-pills"></i> Add Medication
        </a>
        <a asp-action="AddAppointment" asp-route-patientId="@Model.PatientId" class="btn btn-info">
            <i class="fas fa-calendar-plus"></i> Schedule Appointment
        </a>
        <a asp-action="PatientList" class="btn btn-secondary">Back to List</a>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Treatment Updates</h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    @if (Model.TreatmentUpdates?.Any() == true)
                    {
                        @foreach (var update in Model.TreatmentUpdates.OrderByDescending(u => u.UpdateDate))
                        {
                            <div class="border-bottom mb-3 pb-2">
                                <div class="d-flex justify-content-between">
                                    <strong>@update.UpdateType</strong>
                                    <small class="text-muted">@update.UpdateDate.ToString("MMM dd, yyyy")</small>
                                </div>
                                <p class="mb-1">@update.Description</p>
                                @if (!string.IsNullOrEmpty(update.Notes))
                                {
                                    <small class="text-muted">Notes: @update.Notes</small><br/>
                                }
                                <small class="text-muted">By: @update.CreatedBy</small>
                            </div>
                        }
                    }
                    else
                    {
                        <p>No treatment updates yet.</p>
                    }
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Medications</h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    @if (Model.Medications?.Any() == true)
                    {
                        @foreach (var med in Model.Medications.OrderByDescending(m => m.StartDate))
                        {
                            <div class="border-bottom mb-3 pb-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <strong>@med.MedicationName</strong>
                                        <span class="badge @(med.IsActive ? "bg-success" : "bg-secondary") ms-2">
                                            @(med.IsActive ? "Active" : "Inactive")
                                        </span>
                                        <div class="small mt-1">
                                            <strong>Dosage:</strong> @med.Dosage | <strong>Frequency:</strong> @med.Frequency<br/>
                                            <strong>Start:</strong> @med.StartDate.ToString("MMM dd, yyyy")
                                            @if (med.EndDate.HasValue)
                                            {
                                                <span> | <strong>End:</strong> @med.EndDate.Value.ToString("MMM dd, yyyy")</span>
                                            }
                                            @if (!string.IsNullOrEmpty(med.SideEffects))
                                            {
                                                <br/><strong>Side Effects:</strong> @med.SideEffects
                                            }
                                            <br/><small class="text-muted">Prescribed by: @med.PrescribedBy</small>
                                        </div>
                                    </div>
                                    <div class="btn-group-vertical btn-group-sm">
                                        <a asp-controller="Doctor" asp-action="EditMedication" 
                                           asp-route-id="@med.MedicationId"
                                           class="btn btn-warning btn-sm">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                        @if (med.IsActive)
                                        {
                                            <form asp-action="DeactivateMedication" method="post" class="d-inline">
                                                <input type="hidden" name="medicationId" value="@med.MedicationId" />
                                                <button type="submit" 
                                                        class="btn btn-danger btn-sm w-100" 
                                                        onclick="return confirm('Are you sure you want to deactivate this medication?')">
                                                    <i class="fas fa-stop"></i> Stop
                                                </button>
                                            </form>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p>No medications prescribed yet.</p>
                    }
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header">
            <h5>Appointments</h5>
        </div>
        <div class="card-body">
            @if (Model.Appointments?.Any() == true)
            {
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Doctor</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var appt in Model.Appointments.OrderBy(a => a.AppointmentDate))
                        {
                            <tr>
                                <td>@appt.AppointmentDate.ToString("MMM dd, yyyy")</td>
                                <td>@appt.AppointmentDate.ToString("hh:mm tt")</td>
                                <td>@appt.AppointmentType</td>
                                <td>
                                    <span class="badge @(appt.Status == "Scheduled" ? "bg-primary" : appt.Status == "Completed" ? "bg-success" : "bg-secondary")">
                                        @appt.Status
                                    </span>
                                </td>
                                <td>@appt.DoctorName</td>
                                <td>@appt.Notes</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p>No appointments scheduled.</p>
            }
        </div>
    </div>
</div>